<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UNIT 42 PLAYBOOK VIEWER</title>
    <link href="https://fonts.googleapis.com/css?family=Jura:300|Rajdhani|Inconsolata" rel="stylesheet">
    <link rel="icon" type="image/png" href="imgs/u42favicon.ico" sizes="32x32">
    <link rel="stylesheet" href="css/bootstrap-tour-standalone.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/flags.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script defer src="./js/all.js"></script>
    <script src="./js/bootstrap-tour-standalone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="./js/datamaps.world.hires.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/23.0.2/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/23.0.2/styles/ag-theme-balham-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>

    <script src="./js/index.js"></script>
    <script>
      $(document).ready(() => { loadConsts(); });
    </script>
    <style>
      /* küçük kozmetik */
      .pv-header { display:flex; align-items:center; justify-content:space-between; margin:10px 0 8px; }
      .pv-badges span{ display:inline-block; padding:4px 8px; border-radius:6px; margin-left:6px; font-size:12px; }
      .pv-ok { background:#1f7a1f; color:#fff; }
      .pv-err{ background:#a11; color:#fff; }
      .pv-grid { height: 480px; width: 100%; }
      .pv-pre { white-space:pre-wrap; font-family:Inconsolata,monospace; font-size:12px; background:#1e1f26; border:1px solid #333; padding:8px; border-radius:6px; }
      .pv-section { margin-top:10px; }
      .pv-run-btn { cursor:pointer; }
    </style>
</head>

<body>
  <div class="modalcontainer"></div>
  <div class="wrapper">
    <div class="box sidebar">
      <a href="https://unit42.paloaltonetworks.com/" target="_blank">
        <img src="imgs/u42logo.png" alt="">
      </a>
      <div class="action walkthrough"><span>PLAYBOOK WALKTHROUGH</span></div>
      <div class="action view-home"><span>VIEW HOME</span></div>
      <div class="action view-datamap"><span>VIEW MAP</span></div>
      <div class="action filter"><span>FILTER PLAYBOOKS</span></div>
      <div class="action sidebar-clear-filters"><span>CLEAR FILTERS</span></div>

      <!-- Sol menü: butonları buraya basacağız -->
      <div class="playbooks"></div>

      <div class="box footer">
        Created by Palo Alto Networks - Unit 42
        <br><a style="color:#95989a" href="https://attack.mitre.org/wiki/Main_Page">Mitre ATT&amp;CK™</a>
        | <a style="color:#95989a" href="https://oasis-open.github.io/cti-documentation/stix/intro">STIX 2.0</a>
      </div>
    </div>

    <!-- Orta panel -->
    <div class="box contents">
      <!-- içerik JS ile basılacak -->
    </div>
  </div>

  <!-- EN SONA: JSON yükle ve çiz -->
  <script>
  (function () {
    // --- yardımcılar ---
    async function loadJSON(url) {
      const r = await fetch(url, { cache: 'no-cache' });
      if (!r.ok) throw new Error(url + " yüklenemedi (" + r.status + ")");
      return r.json();
    }
    function tryNativeRenderer(data) {
      if (window.renderPlaybook)      { window.renderPlaybook(data); return true; }
      if (window.renderPB)            { window.renderPB(data);       return true; }
      return false;
    }

    // Bizim renderer (runs/*_playbook_viewer.json şemasına göre)
    function renderAtomicRun(data) {
      const root = document.querySelector('.contents');
      root.innerHTML = "";

      const ok = (data.steps || []).filter(s => s.status && s.status.toLowerCase() === 'ok').length;
      const err= (data.steps || []).filter(s => s.status && s.status.toLowerCase() === 'error').length;

      const header = document.createElement('div');
      header.className = 'pv-header';
      header.innerHTML = `
        <h2 style="margin:0">${data.name || 'Atomic Run'}</h2>
        <div class="pv-badges">
          <span class="pv-ok">OK: ${ok}</span>
          <span class="pv-err">ERROR: ${err}</span>
        </div>`;
      root.appendChild(header);

      // üstte küçük özet
      const summary = document.createElement('div');
      summary.className = 'pv-section';
      summary.innerHTML = `
        <div><b>Toplam Adım:</b> ${(data.steps||[]).length}</div>
      `;
      root.appendChild(summary);

      // Grid konteyneri
      const gridWrap = document.createElement('div');
      gridWrap.className = 'pv-section';
      const gridDiv = document.createElement('div');
      gridDiv.className = 'ag-theme-balham-dark pv-grid';
      gridWrap.appendChild(gridDiv);
      root.appendChild(gridWrap);

      // detay alanı
      const detail = document.createElement('div');
      detail.className = 'pv-section';
      detail.innerHTML = `
        <h3>Step Output</h3>
        <div id="pv-detail" class="pv-pre">Bir satır seçin…</div>`;
      root.appendChild(detail);

      // ag-Grid kolonları
      const columnDefs = [
        { headerName: "Host", field: "host", width: 110 },
        { headerName: "OS", field: "os", width: 100 },
        { headerName: "TID", field: "tid", width: 120 },
        { headerName: "Tests", field: "tests", width: 90 },
        { headerName: "Status", field: "status", width: 110,
          cellClass: params => (params.value||'').toLowerCase()==='ok' ? 'pv-ok' : 'pv-err' },
        { headerName: "Start", field: "start", minWidth: 170 },
        { headerName: "End", field: "end", minWidth: 170 },
        { headerName: "Notes", field: "notes", flex: 1 }
      ];

      // veri
      const rowData = (data.steps || []).map(s => ({
        host: s.host, os: s.os, tid: s.tid, tests: s.tests, status: s.status,
        start: s.start, end: s.end, notes: s.notes
      }));

      // grid
      const gridOptions = {
        columnDefs, rowData,
        rowSelection: 'single',
        onRowClicked: e => {
          const step = (data.steps || [])[e.rowIndex];
          const text = [
            step.prereq ? ("[Prereq]\n" + step.prereq.trim()) : "",
            step.output ? ("[Run]\n"    + step.output.trim())  : "",
            step.cleanup? ("[Cleanup]\n"+ step.cleanup.trim()) : "",
          ].filter(Boolean).join("\n\n");
          document.getElementById('pv-detail').textContent = text || "Çıktı yok.";
        },
        defaultColDef: { resizable: true, sortable: true, filter: true }
      };
      new agGrid.Grid(gridDiv, gridOptions);
    }

    // Sol menüye butonlar
    const runs = [
      { title: "Host3 — Atomic Run", url: "runs/host3_playbook_viewer.json" },
      { title: "Host4 — Atomic Run", url: "runs/host4_playbook_viewer.json" }
      // { title: "Host3 + Host4 (Combined)", url: "runs/atomic_run_log.json" }
    ];
    const $list = $(".playbooks");
    runs.forEach(r => {
      const $btn = $("<div/>", { class: "action playbook pv-run-btn", text: r.title })
        .on("click", async () => {
          try {
            const data = await loadJSON(r.url);
            // Orijinal renderer varsa onu dene; yoksa bizimkini kullan
            if (!tryNativeRenderer(data)) renderAtomicRun(data);
          } catch (e) {
            console.error(e);
            alert(e.message);
          }
        });
      $list.append($btn);
    });

    // İsteğe bağlı: URL param ile otomatik yükleme (?run=host3|host4)
    const params = new URLSearchParams(location.search);
    const auto = params.get('run');
    if (auto) {
      const found = runs.find(x => x.title.toLowerCase().includes(auto.toLowerCase()));
      if (found) $list.find('.pv-run-btn').filter((_,el)=>el.textContent===found.title).click();
    }
  })();
  </script>
</body>
</html>
